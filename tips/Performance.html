
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Performance Â· batect documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Charles Korn">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Performance.html" />
    
    
    <link rel="prev" href="IDEIntegration.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Comparison.html">
            
                <a href="../Comparison.html">
            
                    
                    Comparison with other tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Installation.html">
            
                <a href="../Installation.html">
            
                    
                    Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../GettingStarted.html">
            
                <a href="../GettingStarted.html">
            
                    
                    Getting started tutorial
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Configuration file reference</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../config/Overview.html">
            
                <a href="../config/Overview.html">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../config/Containers.html">
            
                <a href="../config/Containers.html">
            
                    
                    Containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../config/Tasks.html">
            
                <a href="../config/Tasks.html">
            
                    
                    Tasks
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Language and tool-specific information</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../tools/Java.html">
            
                <a href="../tools/Java.html">
            
                    
                    Java
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../tools/Java.html">
            
                <a href="../tools/Java.html#gradle">
            
                    
                    Gradle
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../tools/Ruby.html">
            
                <a href="../tools/Ruby.html">
            
                    
                    Ruby
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../tools/Ruby.html">
            
                <a href="../tools/Ruby.html#bundler">
            
                    
                    Bundler
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../tools/Docker.html">
            
                <a href="../tools/Docker.html">
            
                    
                    Docker
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="../tools/Docker.html">
            
                <a href="../tools/Docker.html#building-and-pushing-an-image">
            
                    
                    Building and pushing an image
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Tips and tricks</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="CISetup.html">
            
                <a href="CISetup.html">
            
                    
                    CI setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="IDEIntegration.html">
            
                <a href="IDEIntegration.html">
            
                    
                    IDE integration
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.3" data-path="Performance.html">
            
                <a href="Performance.html">
            
                    
                    Performance
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1" data-path="Performance.html">
            
                <a href="Performance.html#io-performance">
            
                    
                    I/O performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.2" data-path="Performance.html">
            
                <a href="Performance.html#database-schema-and-test-data">
            
                    
                    Database schema and test data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.3" data-path="Performance.html">
            
                <a href="Performance.html#shutdown-time">
            
                    
                    Shutdown time
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="BuildArtifactsOwnedByRoot.html">
            
                <a href="BuildArtifactsOwnedByRoot.html">
            
                    
                    Build artifacts are owned by root
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="WaitingForDependenciesToBeReady.html">
            
                <a href="WaitingForDependenciesToBeReady.html">
            
                    
                    Waiting for dependencies to be ready
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="Proxies.html">
            
                <a href="Proxies.html">
            
                    
                    Proxies
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../SampleProjects.html">
            
                <a href="../SampleProjects.html">
            
                    
                    Sample projects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" >
            
                <a target="_blank" href="https://github.com/charleskorn/batect/releases">
            
                    
                    Release notes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" >
            
                <a target="_blank" href="https://github.com/charleskorn/batect/blob/master/ROADMAP.md">
            
                    
                    Roadmap
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Performance</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="performance">Performance</h1>
<h2 id="io-performance">I/O performance</h2>
<p><div class="alert alert-success hints-alert"><div class="hints-icon"><i class="fa fa-mortar-board"></i></div><div class="hints-container"><p><strong>tl;dr</strong>: if you&apos;re seeing slow build times under batect on OS X, volume mount options such as <code>cached</code> might help</p>
</div></div></p>
<p><div class="alert alert-info hints-alert"><div class="hints-icon"><i class="fa fa-info-circle"></i></div><div class="hints-container"><p>This section only applies to OS X-based hosts, and is only supported by Docker version 17.04 and higher.</p>
</div></div></p>
<p>Docker requires features only found in the Linux kernel, and so on OS X, Docker for Mac runs a lightweight virtual machine
to host Docker. However, while this works perfectly fine for most situations, there is some overhead involved in operations
that need to work across the host / virtual machine boundary.</p>
<p>Usually this overhead is so small that it&apos;s not noticeable, but for operations involving mounted volumes, this overhead can
be significant. In particular, this can impact compilation operations involving reading and writing many files.</p>
<p>There is a way to reduce this overhead significantly: use the
<a href="https://docs.docker.com/docker-for-mac/osxfs-caching/" target="_blank">volume mount options introduced in Docker 17.04</a>.</p>
<p>In particular, for the typical scenario where you are editing code files on your host&apos;s disk and mounting that into a container
for compilation, using the <code>cached</code> volume mount mode can result in a significant performance improvement - we saw an improvement
in compilation times of ~60% on one Golang project once we started using this.</p>
<p>(Before you use these options in another context, you should consult the
<a href="https://docs.docker.com/docker-for-mac/osxfs-caching/" target="_blank">documentation</a> to understand the implications of the option.)</p>
<p>For example, instead of defining your container like this:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">containers:</span>
<span class="hljs-attr">  build-env:</span>
<span class="hljs-attr">    image:</span> <span class="hljs-string">&quot;ruby:2.4.3&quot;</span>
<span class="hljs-attr">    volumes:</span>
<span class="hljs-attr">      - local:</span> .
<span class="hljs-attr">        container:</span> /code
<span class="hljs-attr">    working_directory:</span> /code
</code></pre>
<p>use this:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">containers:</span>
<span class="hljs-attr">  build-env:</span>
<span class="hljs-attr">    image:</span> <span class="hljs-string">&quot;ruby:2.4.3&quot;</span>
<span class="hljs-attr">    volumes:</span>
<span class="hljs-attr">      - local:</span> .
<span class="hljs-attr">        container:</span> /code
<span class="hljs-attr">        options:</span> cached <span class="hljs-comment"># This enables &apos;cached&apos; mode for the /code mount</span>
<span class="hljs-attr">    working_directory:</span> /code
</code></pre>
<p>Setting this option will not affect Linux hosts, so it&apos;s safe to commit and share this in a project where some developers use
OS X and others use Linux.</p>
<h2 id="database-schema-and-test-data">Database schema and test data</h2>
<p><div class="alert alert-success hints-alert"><div class="hints-icon"><i class="fa fa-mortar-board"></i></div><div class="hints-container"><p><strong>tl;dr</strong>: try to do as much work as possible at image build time, rather than doing it every time the container starts</p>
</div></div></p>
<p>A significant amount of time during integration or journey testing with a database can be taken up by preparing the database for
use - setting up the schema (usually with some kind of migrations system) and adding the initial test data can take quite some time,
especially as the application evolves over time.</p>
<p>One way to address this is to bake the schema and test data into the Docker image used for the database, so that this setup cost only
has to be paid when building the image or when the setup changes, rather than on every test run. The exact method for doing this will
vary depending on the database system you&apos;re using, but the general steps that would go in your Dockerfile are:</p>
<ol>
<li>Copy schema and test data scripts into container</li>
<li>Temporarily start database daemon</li>
<li>Run schema and data scripts against database instance</li>
<li>Shut down database daemon</li>
</ol>
<h2 id="shutdown-time">Shutdown time</h2>
<p><div class="alert alert-success hints-alert"><div class="hints-icon"><i class="fa fa-mortar-board"></i></div><div class="hints-container"><p><strong>tl;dr</strong>: make sure signals such as SIGTERM and SIGKILL are being passed to the main process</p>
</div></div></p>
<p>If you notice that post-task cleanup for a container is taking longer than expected, and that container starts the main process from a
Bash script, make sure that signals such as SIGTERM and SIGKILL are being forwarded to the process. (Otherwise Docker will wait 10
seconds for the application to respond to the signal before just terminating the process.)</p>
<p>For example, instead of using:</p>
<pre><code class="lang-bash">/app/my-really-cool-app --do-stuff
</code></pre>
<p>use this:</p>
<pre><code class="lang-bash"><span class="hljs-built_in">exec</span> /app/my-really-cool-app --do-stuff
</code></pre>
<p>(<a href="https://unix.stackexchange.com/a/196053/258093" target="_blank">source</a>)</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="IDEIntegration.html" class="navigation navigation-prev " aria-label="Previous page: IDE integration">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Performance.html#io-performance" class="navigation navigation-next " aria-label="Next page: I/O performance">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Performance","level":"4.3","depth":1,"next":{"title":"I/O performance","level":"4.3.1","depth":2,"anchor":"#io-performance","path":"tips/Performance.md","ref":"tips/Performance.md#io-performance","articles":[]},"previous":{"title":"IDE integration","level":"4.2","depth":1,"path":"tips/IDEIntegration.md","ref":"tips/IDEIntegration.md","articles":[]},"dir":"ltr"},"config":{"plugins":["ga","github","hints"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"github":{"url":"https://github.com/charleskorn/batect"},"search":{},"hints":{"danger":"fa fa-exclamation-circle","info":"fa fa-info-circle","tip":"fa fa-mortar-board","working":"fa fa-wrench"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"ga":{"configuration":"auto","token":"UA-63947227-2"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Charles Korn","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"Introduction.md","glossary":"GLOSSARY.md","summary":"Contents.md"},"variables":{},"title":"batect documentation","language":"en","gitbook":"*","description":"Documentation for batect, the build and testing environments as code tool"},"file":{"path":"tips/Performance.md","mtime":"2018-10-17T04:23:54.872Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-10-17T04:28:23.726Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

